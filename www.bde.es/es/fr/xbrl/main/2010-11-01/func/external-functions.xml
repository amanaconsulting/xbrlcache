<?xml version="1.0" encoding="UTF-8"?>
<!--© Copyright Banco de España. Reservados todos los derechos-->            
<link:linkbase xmlns:link="http://www.xbrl.org/2003/linkbase" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:d-cr="http://www.c-ebs.org/eu/fr/esrs/corep/2006-07-01/d-cr-2006-07-01" xmlns:generic="http://xbrl.org/2008/generic" xmlns:ca="http://xbrl.org/2008/assertion/consistency" xmlns:p-ca="http://www.c-ebs.org/eu/fr/esrs/corep/2006-07-01/p-ca-2006-07-01" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:tf="http://xbrl.org/2008/filter/tuple" xmlns:gf="http://xbrl.org/2008/filter/general" xmlns:xfi="http://www.xbrl.org/2008/function/instance" xmlns:ea="http://xbrl.org/2008/assertion/existence" xmlns:ra="http://www.bde.es/xbrl/util/formulae/rules/auxiliar" xmlns:frRef="http://www.bde.es/es/fr/esrs/comun/2010-01-01/formulareferencias" xmlns:d-ec="http://www.c-ebs.org/eu/fr/esrs/corep/2006-07-01/d-ec-2006-07-01" xmlns:df="http://xbrl.org/2008/filter/dimension" xmlns:mf="http://xbrl.org/2008/filter/match" xmlns:xbrli="http://www.xbrl.org/2003/instance" xmlns:va="http://xbrl.org/2008/assertion/value" xmlns:instance="http://xbrl.org/2010/variable/instance" xmlns:fext="http://www.bde.es/es/fr/xbrl/main/functions/external" xmlns:fn="http://www.w3.org/2005/xpath-functions" xmlns:p-cm-cr="http://www.c-ebs.org/eu/fr/esrs/corep/2006-07-01/p-cm-cr-2006-07-01" xmlns:uf="http://xbrl.org/2008/filter/unit" xmlns:validation="http://xbrl.org/2008/validation" xmlns:label="http://xbrl.org/2008/label" xmlns:es-be-cm-pblo="http://www.bde.es/es/fr/esrs/comun/2008-06-01/preambulo" xmlns:reference="http://xbrl.org/2008/reference" xmlns:ref="http://www.xbrl.org/2006/ref" xmlns:pf="http://xbrl.org/2008/filter/period" xmlns:ef="http://xbrl.org/2008/filter/entity" xmlns:r="http://www.bde.es/xbrl/util/formulae/2010/rules" xmlns:cebs-ef-att="http://www.c-ebs.org/eu/fr/esrs/eurofiling/2010-01-01/attributes" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:cf="http://xbrl.org/2008/filter/concept" xmlns:variable="http://xbrl.org/2008/variable" xmlns:d-oe="http://www.c-ebs.org/eu/fr/esrs/corep/2006-07-01/d-oe-2006-07-01" xmlns:formula="http://xbrl.org/2008/formula" xmlns:cfi="http://xbrl.org/2010/custom-function" xsi:schemaLocation="http://www.xbrl.org/2003/linkbase http://www.xbrl.org/2003/xbrl-linkbase-2003-12-31.xsd http://xbrl.org/2008/generic http://www.xbrl.org/2008/generic-link.xsd http://xbrl.org/2008/variable http://www.xbrl.org/2008/variable.xsd http://xbrl.org/2010/custom-function http://www.xbrl.org/2010/custom-function-implementation.xsd">

   <link:arcroleRef arcroleURI="http://xbrl.org/arcrole/2010/function-implementation" xlink:type="simple" xlink:href="http://www.xbrl.org/2010/custom-function-implementation.xsd#cfi-implementation"/>
   
   
   <generic:link xlink:type="extended" xlink:role="http://www.xbrl.org/2003/role/link">


<variable:function xlink:type="resource" xlink:label="fext_SolicitarAtributoEF_function" name="fext:SolicitarAtributoEF" output="item()*">
         <variable:input type="xs:string"/>
      </variable:function>
      <cfi:implementation xlink:type="resource" xlink:label="fext_SolicitarAtributoEF_implementation" xlink:title="implementation">
         <cfi:input name="nombre"/>
         <cfi:output>fext:_atributo($nombre, 'EF')</cfi:output>
      </cfi:implementation>
      <generic:arc xlink:type="arc" xlink:arcrole="http://xbrl.org/arcrole/2010/function-implementation" xlink:from="fext_SolicitarAtributoEF_function" xlink:to="fext_SolicitarAtributoEF_implementation" xlink:title="unknown: function to implementation" order="1.0"/>
      
      <variable:function xlink:type="resource" xlink:label="fext_SolicitarAtributoEFString_function" name="fext:SolicitarAtributoEFString" output="item()*">
         <variable:input type="xs:string"/>
      </variable:function>
      <cfi:implementation xlink:type="resource" xlink:label="fext_SolicitarAtributoEFString_implementation" xlink:title="implementation">
         <cfi:input name="nombre"/>
         <cfi:output>fext:_atributo($nombre, 'EF')</cfi:output>
      </cfi:implementation>
      <generic:arc xlink:type="arc" xlink:arcrole="http://xbrl.org/arcrole/2010/function-implementation" xlink:from="fext_SolicitarAtributoEFString_function" xlink:to="fext_SolicitarAtributoEFString_implementation" xlink:title="unknown: function to implementation" order="1.0"/>
      
      <variable:function xlink:type="resource" xlink:label="fext_SolicitarAtributoEFNumerico_function" name="fext:SolicitarAtributoEFNumerico" output="item()*">
         <variable:input type="xs:string"/>
      </variable:function>
      <cfi:implementation xlink:type="resource" xlink:label="fext_SolicitarAtributoEFNumerico_implementation" xlink:title="implementation">
         <cfi:input name="nombre"/>
         <cfi:output>fext:_atributo($nombre, 'EF')</cfi:output>
      </cfi:implementation>
      <generic:arc xlink:type="arc" xlink:arcrole="http://xbrl.org/arcrole/2010/function-implementation" xlink:from="fext_SolicitarAtributoEFNumerico_function" xlink:to="fext_SolicitarAtributoEFNumerico_implementation" xlink:title="unknown: function to implementation" order="1.0"/>
      
      <variable:function xlink:type="resource" xlink:label="fext_SolicitarAtributo_function" name="fext:SolicitarAtributo" output="item()*">
         <variable:input type="xs:string"/>
         <variable:input type="xs:string"/>
         <variable:input type="xs:string"/>
         <variable:input type="xs:date"/>
      </variable:function>
      <cfi:implementation xlink:type="resource" xlink:label="fext_SolicitarAtributo_implementation" xlink:title="implementation">
         <cfi:input name="entidad"/>
         <cfi:input name="tipoObjeto"/>
         <cfi:input name="nombre"/>
         <cfi:input name="fecha"/>
         <cfi:output>fext:_atributo($nombre, $tipoObjeto, $entidad, $fecha)</cfi:output>
      </cfi:implementation>
      <generic:arc xlink:type="arc" xlink:arcrole="http://xbrl.org/arcrole/2010/function-implementation" xlink:from="fext_SolicitarAtributo_function" xlink:to="fext_SolicitarAtributo_implementation" xlink:title="unknown: function to implementation" order="1.0"/>
      
      <variable:function xlink:type="resource" xlink:label="fext_SolicitarAtributoString_function" output="item()*" name="fext:SolicitarAtributoString">
         <variable:input type="xs:string"/>
         <variable:input type="xs:string"/>
         <variable:input type="xs:string"/>
         <variable:input type="xs:date"/>
      </variable:function>
      <cfi:implementation xlink:type="resource" xlink:label="fext_SolicitarAtributoString_implementation" xlink:title="implementation">
         <cfi:input name="entidad"/>
         <cfi:input name="tipoObjeto"/>
         <cfi:input name="nombre"/>
         <cfi:input name="fecha"/>
         <cfi:output>fext:_atributo($nombre, $tipoObjeto, $entidad, $fecha)</cfi:output>
      </cfi:implementation>
      <generic:arc xlink:type="arc" xlink:arcrole="http://xbrl.org/arcrole/2010/function-implementation" xlink:from="fext_SolicitarAtributoString_function" xlink:to="fext_SolicitarAtributoString_implementation" xlink:title="unknown: function to implementation" order="1.0"/>
      
      <variable:function xlink:type="resource" xlink:label="fext_SolicitarAtributoNumerico_function" output="item()*" name="fext:SolicitarAtributoInteger">
         <variable:input type="xs:string"/>
         <variable:input type="xs:string"/>
         <variable:input type="xs:string"/>
         <variable:input type="xs:date"/>
      </variable:function>
	  <cfi:implementation xlink:type="resource" xlink:label="fext_SolicitarAtributoNumerico_implementation" xlink:title="implementation">
         <cfi:input name="entidad"/>
         <cfi:input name="tipoObjeto"/>
         <cfi:input name="nombre"/>
         <cfi:input name="fecha"/>
         <cfi:output>fext:_atributo($nombre, $tipoObjeto, $entidad, $fecha)</cfi:output>
      </cfi:implementation>
      <generic:arc xlink:type="arc" xlink:arcrole="http://xbrl.org/arcrole/2010/function-implementation" xlink:from="fext_SolicitarAtributoNumerico_function" xlink:to="fext_SolicitarAtributoNumerico_implementation" xlink:title="unknown: function to implementation" order="1.0"/>
      
      
      <variable:function xlink:type="resource" xlink:label="fext_SolicitarContravalorMonedaNum" name="fext:SolicitarContravalorMonedaNum" output="xs:double?">
         <variable:input type="xs:decimal"/>
         <variable:input type="xs:string"/>
         <variable:input type="xs:date"/>
      </variable:function>

      <variable:function xlink:type="resource" xlink:label="fext_SolicitarContravalorMonedaAlfa" name="fext:SolicitarContravalorMonedaAlfa" output="xs:double?">
         <variable:input type="xs:string"/>
         <variable:input type="xs:string"/>
         <variable:input type="xs:date"/>
      </variable:function>

      <variable:function xlink:type="resource" xlink:label="fext_SolicitarObligatoriedadDeclararEstado" name="fext:SolicitarObligatoriedadDeclararEstado" output="xs:boolean?">
         <variable:input type="xs:string"/>
         <variable:input type="xs:date"/>
         <variable:input type="xs:string"/>
         <variable:input type="xs:string"/>
      </variable:function>
      
      <variable:function xlink:type="resource" xlink:label="fext_EsNoResidente" name="fext:EsNoResidente" output="xs:boolean?">
         <variable:input type="xs:string"/>
      </variable:function>
      
      <variable:function xlink:type="resource" xlink:label="fext_EsNifValido" name="fext:EsNifValido" output="xs:boolean?">
         <variable:input type="xs:string"/>
      </variable:function>
      
      <variable:function xlink:type="resource" xlink:label="fext_obtenerCodigoBE" name="fext:obtenerCodigoBE" output="xs:string?">
         <variable:input type="xs:string"/>
      </variable:function>
      
      <variable:function xlink:type="resource" xlink:label="fext_EsEstadoAceptado" name="fext:EsEstadoAceptado" output="xs:boolean?">
         <variable:input type="xs:string"/>
         <variable:input type="xs:string"/>
         <variable:input type="xs:string"/>
         <variable:input type="xs:date"/>
         <variable:input type="xs:string"/>
      </variable:function>
      
      <variable:function xlink:type="resource" xlink:label="fext_SolicitarPredicado" name="fext:SolicitarPredicado" output="xs:boolean?">
         <variable:input type="xs:date"/>
         <variable:input type="xs:string"/>
         <variable:input type="xs:string"/>
         <variable:input type="xs:string"/>
      </variable:function>
      
      <variable:function xlink:type="resource" xlink:label="fext_ConsultaCeldas" name="fext:ConsultaCeldas" output="xs:string*">
         <variable:input type="xs:string"/>
         <variable:input type="xs:string*"/>
         <variable:input type="xs:dateTime"/>
         <variable:input type="xs:dateTime*"/>
         <variable:input type="xs:dateTime*"/>
         <variable:input type="xs:dateTime*"/>
         <variable:input type="xs:string"/>
      </variable:function>

      <variable:function xlink:type="resource" xlink:label="fext_SolicitarObligatoriedadDeclararEstadoDatosInstancia" name="fext:SolicitarObligatoriedadDeclararEstadoDatosInstancia" output="xs:boolean?">
         <variable:input type="xs:string"/>
      </variable:function>

      <variable:function xlink:type="resource" xlink:label="fext_SolicitarPredicadoDatosInstancia" name="fext:SolicitarPredicadoDatosInstancia" output="xs:boolean?">
         <variable:input type="xs:string"/>
      </variable:function>

      <variable:function xlink:type="resource" xlink:label="function_1" xlink:title="function" name="fext:CalculoRiesgoPais" output="xs:double?">
         <variable:input type="xs:string"/>
         <variable:input type="xs:date"/>
      </variable:function>
      <cfi:implementation xlink:type="resource" xlink:label="implementation_1" xlink:title="implementation">
         <cfi:input name="pais"/>
         <cfi:input name="fecha"/>
         <cfi:output>fext:SolicitarAtributoInteger($pais,'PA','TO_GR_RIES',$fecha)</cfi:output>
      </cfi:implementation>
      <generic:arc xlink:type="arc" xlink:arcrole="http://xbrl.org/arcrole/2010/function-implementation" xlink:from="function_1" xlink:to="implementation_1" xlink:title="unknown: function to implementation" order="1.0"/>
      
      <variable:function xlink:type="resource" xlink:label="function_2" xlink:title="function" name="fext:RiesgoPais" output="xs:double*">
         <variable:input type="xs:string*"/>
         <variable:input type="xs:date"/>
      </variable:function>
      <cfi:implementation xlink:type="resource" xlink:label="implementation_2" xlink:title="implementation">
         <cfi:input name="paises"/>
         <cfi:input name="fecha"/>
         <cfi:output>for $i in $paises return fext:CalculoRiesgoPais($i,$fecha)</cfi:output>
      </cfi:implementation>
      <generic:arc xlink:type="arc" xlink:arcrole="http://xbrl.org/arcrole/2010/function-implementation" xlink:from="function_2" xlink:to="implementation_2" xlink:title="unknown: function to implementation" order="2.0"/>

      <variable:function xlink:type="resource" xlink:label="function_3" xlink:title="function" name="fext:CalculoPredicado" output="xs:boolean">
         <variable:input type="xs:date"/> 
         <variable:input type="xs:string"/>
         <variable:input type="xs:string"/>
         <variable:input type="xs:string"/>
      </variable:function>
      <cfi:implementation xlink:type="resource" xlink:label="implementation_3" xlink:title="implementation">
         <cfi:input name="fecha"/>
         <cfi:input name="entidad"/>
         <cfi:input name="agrupacion"/>
         <cfi:input name="predicado"/>
         <cfi:output>fext:SolicitarPredicado($fecha,$entidad,$agrupacion,$predicado)</cfi:output>
      </cfi:implementation>
      <generic:arc xlink:type="arc" xlink:arcrole="http://xbrl.org/arcrole/2010/function-implementation" xlink:from="function_3" xlink:to="implementation_3" xlink:title="unknown: function to implementation" order="3.0"/>
      
      <variable:function xlink:type="resource" xlink:label="function_4" xlink:title="function" name="fext:RespuestaPredicados" output="xs:boolean*">
         <variable:input type="xs:date*"/>
         <variable:input type="xs:string"/>
         <variable:input type="xs:string"/>
         <variable:input type="xs:string"/>
      </variable:function>
      <cfi:implementation xlink:type="resource" xlink:label="implementation_4" xlink:title="implementation">
         <cfi:input name="fechas"/>
         <cfi:input name="entidad"/>
         <cfi:input name="agrupacion"/>
         <cfi:input name="predicado"/>
         <cfi:output>for $i in $fechas return fext:CalculoPredicado($i,$entidad,$agrupacion,$predicado)</cfi:output>
      </cfi:implementation>
      <generic:arc xlink:type="arc" xlink:arcrole="http://xbrl.org/arcrole/2010/function-implementation" xlink:from="function_4" xlink:to="implementation_4" xlink:title="unknown: function to implementation" order="4.0"/>
      <variable:function xlink:type="resource" xlink:label="ent-erroneas" name="fext:ent-erroneas" output="xs:string*">
         <variable:input type="xs:string*"/>
      </variable:function>
      <cfi:implementation xlink:type="resource" xlink:label="ent-erroneas_imp">
         <cfi:input name="codigos"/>
         <cfi:output>for $i in $codigos return fext:ent-erronea($i)</cfi:output>
      </cfi:implementation>
      <generic:arc xlink:type="arc" xlink:arcrole="http://xbrl.org/arcrole/2010/function-implementation" xlink:from="ent-erroneas" xlink:to="ent-erroneas_imp"/>

      <variable:function xlink:type="resource" xlink:label="ent-erronea" name="fext:ent-erronea" output="xs:string?">
         <variable:input type="xs:string"/>
      </variable:function>
      <cfi:implementation xlink:type="resource" xlink:label="ent-erronea_imp">
         <cfi:input name="codigo"/>
         <cfi:step name="longitud">string-length($codigo)</cfi:step>
         <cfi:step name="error">
            if ($longitud lt 4) then 'Longitud codigo erronea' else
            if ($longitud = 4) then fext:codigo-be-erroneo($codigo) else
            if ($longitud gt 9) then fext:codigo-nores-erroneo($codigo) else
            fext:nif-erroneo($codigo)
         </cfi:step>
         <cfi:output>if ($error) then concat($codigo, ': ', $error) else ()</cfi:output>
      </cfi:implementation>
      <generic:arc xlink:type="arc" xlink:arcrole="http://xbrl.org/arcrole/2010/function-implementation" xlink:from="ent-erronea" xlink:to="ent-erronea_imp"/>
      
      <variable:function xlink:type="resource" xlink:label="codigo-be-erroneo" name="fext:codigo-be-erroneo" output="xs:string?">
         <variable:input type="xs:string"/>
      </variable:function>
      <cfi:implementation xlink:type="resource" xlink:label="codigo-be-erroneo_imp">
         <cfi:input name="codigo"/>
         <cfi:step name="tipoEntidad">fext:atributo-entidad('TO_TIP_REN', $codigo)</cfi:step>
         <!-- Si no tiene el atributo tipo de entidad, se asume que no es un codigo BE valido -->
         <cfi:output>if ((string-length($tipoEntidad) gt 0) and ($tipoEntidad ne 'BAJA')) then () else 'Codigo BE invalido'</cfi:output>
      </cfi:implementation>
      <generic:arc xlink:type="arc" xlink:arcrole="http://xbrl.org/arcrole/2010/function-implementation" xlink:from="codigo-be-erroneo" xlink:to="codigo-be-erroneo_imp"/>

      <variable:function xlink:type="resource" xlink:label="codigo-nores-erroneo" name="fext:codigo-nores-erroneo" output="xs:string?">
         <variable:input type="xs:string"/>
      </variable:function>
      <cfi:implementation xlink:type="resource" xlink:label="codigo-nores-erroneo_imp">
         <cfi:input name="codigo"/>
         <cfi:output>if (fext:EsNoResidente($codigo)) then () else 'Codigo de no residente invalido'</cfi:output>
      </cfi:implementation>
      <generic:arc xlink:type="arc" xlink:arcrole="http://xbrl.org/arcrole/2010/function-implementation" xlink:from="codigo-nores-erroneo" xlink:to="codigo-nores-erroneo_imp"/>     

      <variable:function xlink:type="resource" xlink:label="nif-erroneo" name="fext:nif-erroneo" output="xs:string?">
         <variable:input type="xs:string"/>
      </variable:function>
      <cfi:implementation xlink:type="resource" xlink:label="nif-erroneo_imp">
         <cfi:input name="codigo"/>
         <cfi:output>
            if (not(fext:EsNifValido($codigo))) then 'NIF invalido' else
            if (string-length(fext:obtenerCodigoBE($codigo)) gt 0) then 'NIF corresponde a un código BE' else ()
         </cfi:output>
      </cfi:implementation>
      <generic:arc xlink:type="arc" xlink:arcrole="http://xbrl.org/arcrole/2010/function-implementation" xlink:from="nif-erroneo" xlink:to="nif-erroneo_imp"/>    
   </generic:link>
</link:linkbase>
